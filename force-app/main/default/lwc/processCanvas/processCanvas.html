<!--
  @description: SVG Canvas template for BPMN process diagram editor - POC Style
  @author: Dennis van Musschenbroek (DvM) - Cobra CRM B.V.
  @date: 2024-12-14
  @version: 1.1.1
  
  EXPLANATION:
  This template renders the interactive SVG canvas for BPMN diagrams.
  POC-style design with:
  - Labels BELOW elements (not overlapping)
  - Icons centered within elements  
  - Blue stroke overlay when selected (not dashed box)
  - Connection points on shape edges/corners
  - CFC complexity badges on split gateways
  - Complexity indicators legend (bottom-left)
  
  CHANGELOG:
  Version | Date       | Author | Description
  ---------|------------|--------|------------------------------------------
  1.0.0   | 2024-12-12 | DvM    | Initial creation - core canvas template
  1.0.1   | 2024-12-12 | DvM    | Fixed: moved all inline expressions to JS getters
  1.0.2   | 2024-12-12 | DvM    | Fixed: POC-style labels, icons, selection
  1.1.0   | 2024-12-14 | DvM    | Added: CFC complexity badges on gateways
  1.1.1   | 2024-12-14 | DvM    | Added: Complexity indicators legend (bottom-left)
-->
<template>
    <div class="canvas-container" tabindex="0">
        <!-- SVG Canvas -->
        <svg 
            class="canvas-svg"
            viewBox={viewBoxString}
            onmousedown={handleCanvasMouseDown}
            onmousemove={handleCanvasMouseMove}
            onmouseup={handleCanvasMouseUp}
            onmouseleave={handleCanvasMouseLeave}
            onwheel={handleCanvasWheel}
            ondragover={handleCanvasDragOver}
            ondrop={handleCanvasDrop}
        >
            <!-- SVG Definitions -->
            <!-- NOTE: refX/refY are set programmatically in JS due to LWC restrictions -->
            <defs>
                <!-- Arrow marker for connections -->
                <marker
                    id="arrowhead"
                    markerWidth="10"
                    markerHeight="7"
                    orient="auto"
                    viewBox="0 0 10 7"
                >
                    <polygon points="0 0, 10 3.5, 0 7" fill="#2D3748"></polygon>
                </marker>
            </defs>
            
            <!-- Background for click/pan handling -->
            <rect 
                class="canvas-background"
                x="-10000" 
                y="-10000" 
                width="20000" 
                height="20000" 
                fill="rgba(0,0,0,0)"
            ></rect>
            
            <!-- Connections (rendered behind elements) -->
            <g class="connections-layer">
                <template for:each={renderedConnections} for:item="conn">
                    <g key={conn.id} class={conn.cssClass} data-id={conn.id} onclick={handleConnectionClick}>
                        <!-- Invisible wider path for easier clicking -->
                        <path 
                            d={conn.path} 
                            fill="none" 
                            stroke="transparent" 
                            stroke-width="15"
                            class="connection-hitarea"
                        ></path>
                        <!-- Visible connection line -->
                        <path 
                            d={conn.path} 
                            fill="none" 
                            stroke={conn.stroke}
                            stroke-width={conn.strokeWidth}
                            stroke-dasharray={conn.dashArray}
                            marker-end="url(#arrowhead)"
                            class="connection-line"
                        ></path>
                    </g>
                </template>
            </g>
            
            <!-- Temporary connection line (when creating new connection) -->
            <template if:true={isConnecting}>
                <line 
                    class="temp-connection"
                    x1={tempLineX1}
                    y1={tempLineY1}
                    x2={tempLineX2}
                    y2={tempLineY2}
                    stroke="#3182CE"
                    stroke-width="2"
                    stroke-dasharray="5,5"
                    marker-end="url(#arrowhead)"
                ></line>
            </template>
            
            <!-- Elements -->
            <g class="elements-layer">
                <template for:each={renderedElements} for:item="el">
                    <g 
                        key={el.id} 
                        class={el.cssClass}
                        data-id={el.id}
                        onmousedown={handleElementMouseDown}
                        ondblclick={handleElementDoubleClick}
                    >
                        <!-- ============================================ -->
                        <!-- CIRCLE SHAPES (Events) -->
                        <!-- ============================================ -->
                        <template if:true={el.isCircle}>
                            <!-- Selection: Blue stroke overlay (POC style) -->
                            <template if:true={el.isSelected}>
                                <circle
                                    cx={el.centerX}
                                    cy={el.centerY}
                                    r={el.radius}
                                    fill="none"
                                    stroke="#3182CE"
                                    stroke-width="3"
                                    class="selection-stroke"
                                ></circle>
                            </template>
                            
                            <!-- Main circle -->
                            <circle
                                cx={el.centerX}
                                cy={el.centerY}
                                r={el.radius}
                                fill={el.fill}
                                stroke={el.stroke}
                                stroke-width={el.strokeWidth}
                            ></circle>
                            
                            <!-- Inner circle for intermediate events -->
                            <template if:true={el.double}>
                                <circle
                                    cx={el.centerX}
                                    cy={el.centerY}
                                    r={el.innerRadius}
                                    fill="none"
                                    stroke={el.stroke}
                                    stroke-width="1.5"
                                ></circle>
                            </template>
                            
                            <!-- Event label (below) - Line 1 always shown -->
                            <text
                                x={el.labelX}
                                y={el.labelY}
                                text-anchor="middle"
                                dominant-baseline="hanging"
                                class="element-label"
                            >{el.labelLine1}</text>
                            <!-- Event label Line 2 (only if hasLine2) -->
                            <template if:true={el.hasLine2}>
                                <text
                                    x={el.labelX}
                                    y={el.labelLine2Y}
                                    text-anchor="middle"
                                    dominant-baseline="hanging"
                                    class="element-label"
                                >{el.labelLine2}</text>
                            </template>
                        </template>
                        
                        <!-- ============================================ -->
                        <!-- RECTANGLE SHAPES (Tasks) -->
                        <!-- ============================================ -->
                        <template if:true={el.isRect}>
                            <!-- Selection: Blue stroke overlay -->
                            <template if:true={el.isSelected}>
                                <rect
                                    x={el.x}
                                    y={el.y}
                                    width={el.width}
                                    height={el.height}
                                    fill="none"
                                    stroke="#3182CE"
                                    stroke-width="3"
                                    rx={el.rx}
                                    class="selection-stroke"
                                ></rect>
                            </template>
                            
                            <!-- Main rectangle -->
                            <rect
                                x={el.x}
                                y={el.y}
                                width={el.width}
                                height={el.height}
                                fill={el.fill}
                                stroke={el.stroke}
                                stroke-width={el.strokeWidth}
                                rx={el.rx}
                                stroke-dasharray={el.strokeDasharray}
                            ></rect>
                            
                            <!-- Loop indicator: Striped border overlay for elements in a loop -->
                            <template if:true={el.isInLoop}>
                                <rect
                                    x={el.x}
                                    y={el.y}
                                    width={el.width}
                                    height={el.height}
                                    fill="none"
                                    stroke={el.loopStroke}
                                    stroke-width="3"
                                    stroke-dasharray="8,4"
                                    rx={el.rx}
                                    class="loop-indicator"
                                ></rect>
                                <!-- Loop badge (small circle with loop icon) at top-right -->
                                <circle
                                    cx={el.loopBadgeX}
                                    cy={el.loopBadgeY}
                                    r="10"
                                    fill={el.loopStroke}
                                    stroke="white"
                                    stroke-width="2"
                                ></circle>
                                <text
                                    x={el.loopBadgeX}
                                    y={el.loopBadgeY}
                                    text-anchor="middle"
                                    dominant-baseline="middle"
                                    fill="white"
                                    font-size="10"
                                >â†»</text>
                            </template>
                            
                            <!-- Task label (inside, centered) - Line 1 always shown -->
                            <text
                                x={el.centerX}
                                y={el.labelLine1Y}
                                text-anchor="middle"
                                dominant-baseline="middle"
                                class="element-label"
                            >{el.labelLine1}</text>
                            <!-- Task label Line 2 (only if hasLine2) -->
                            <template if:true={el.hasLine2}>
                                <text
                                    x={el.centerX}
                                    y={el.labelLine2Y}
                                    text-anchor="middle"
                                    dominant-baseline="middle"
                                    class="element-label"
                                >{el.labelLine2}</text>
                            </template>
                            <!-- Task label Line 3 (only if hasLine3) -->
                            <template if:true={el.hasLine3}>
                                <text
                                    x={el.centerX}
                                    y={el.labelLine3Y}
                                    text-anchor="middle"
                                    dominant-baseline="middle"
                                    class="element-label"
                                >{el.labelLine3}</text>
                            </template>
                            
                            <!-- Task type icons (top-left corner) -->
                            <template if:true={el.showUserIcon}>
                                <g transform={el.iconTransform}>
                                    <circle cx="10" cy="6" r="4" fill="none" stroke="#4A5568" stroke-width="1.5"></circle>
                                    <path d="M3 18c0-4 3-5 7-5s7 1 7 5" fill="none" stroke="#4A5568" stroke-width="1.5"></path>
                                </g>
                            </template>
                            <template if:true={el.showServiceIcon}>
                                <g transform={el.iconTransform}>
                                    <circle cx="10" cy="10" r="6" fill="none" stroke="#4A5568" stroke-width="1.5"></circle>
                                    <circle cx="10" cy="10" r="2" fill="#4A5568"></circle>
                                    <path d="M10 2v4M10 14v4M2 10h4M14 10h4" stroke="#4A5568" stroke-width="1.5"></path>
                                </g>
                            </template>
                            <template if:true={el.showScriptIcon}>
                                <g transform={el.iconTransform}>
                                    <rect x="3" y="2" width="14" height="16" rx="2" fill="none" stroke="#4A5568" stroke-width="1.5"></rect>
                                    <path d="M6 6h8M6 10h8M6 14h5" stroke="#4A5568" stroke-width="1.5"></path>
                                </g>
                            </template>
                            <template if:true={el.showManualIcon}>
                                <g transform={el.iconTransform}>
                                    <path d="M4 8c0-2 2-4 6-4s6 2 6 4v8H4V8z" fill="none" stroke="#4A5568" stroke-width="1.5"></path>
                                    <path d="M7 12h6" stroke="#4A5568" stroke-width="1.5"></path>
                                </g>
                            </template>
                            <template if:true={el.showRuleIcon}>
                                <g transform={el.iconTransform}>
                                    <rect x="2" y="2" width="16" height="16" rx="2" fill="none" stroke="#4A5568" stroke-width="1.5"></rect>
                                    <path d="M2 7h16M7 7v11" stroke="#4A5568" stroke-width="1.5"></path>
                                </g>
                            </template>
                            <template if:true={el.showSendIcon}>
                                <g transform={el.iconTransform}>
                                    <rect x="2" y="4" width="16" height="12" rx="2" fill="none" stroke="#4A5568" stroke-width="1.5"></rect>
                                    <path d="M2 6l8 5 8-5" fill="none" stroke="#4A5568" stroke-width="1.5"></path>
                                </g>
                            </template>
                            <template if:true={el.showReceiveIcon}>
                                <g transform={el.iconTransform}>
                                    <rect x="2" y="4" width="16" height="12" rx="2" fill="none" stroke="#4A5568" stroke-width="1.5"></rect>
                                    <path d="M2 6l8 5 8-5" fill="none" stroke="#4A5568" stroke-width="1.5"></path>
                                    <circle cx="10" cy="12" r="2" fill="#4A5568"></circle>
                                </g>
                            </template>
                            <template if:true={el.showScreenIcon}>
                                <g transform={el.iconTransform}>
                                    <rect x="2" y="3" width="16" height="11" rx="1" fill="none" stroke="#4A5568" stroke-width="1.5"></rect>
                                    <path d="M7 17h6M10 14v3" stroke="#4A5568" stroke-width="1.5"></path>
                                </g>
                            </template>
                            <template if:true={el.showCreateIcon}>
                                <g transform={el.iconTransform}>
                                    <circle cx="10" cy="10" r="8" fill="none" stroke="#22863A" stroke-width="1.5"></circle>
                                    <path d="M10 6v8M6 10h8" stroke="#22863A" stroke-width="2"></path>
                                </g>
                            </template>
                            <template if:true={el.showUpdateIcon}>
                                <g transform={el.iconTransform}>
                                    <path d="M14 3l3 3-9 9H5v-3l9-9z" fill="none" stroke="#2B6CB0" stroke-width="1.5"></path>
                                    <path d="M12 5l3 3" stroke="#2B6CB0" stroke-width="1.5"></path>
                                </g>
                            </template>
                            <template if:true={el.showDeleteIcon}>
                                <g transform={el.iconTransform}>
                                    <path d="M4 6h12M6 6v10a2 2 0 002 2h4a2 2 0 002-2V6M8 6V4a1 1 0 011-1h2a1 1 0 011 1v2" fill="none" stroke="#C53030" stroke-width="1.5"></path>
                                </g>
                            </template>
                            <template if:true={el.showLookupIcon}>
                                <g transform={el.iconTransform}>
                                    <circle cx="9" cy="9" r="6" fill="none" stroke="#6B46C1" stroke-width="1.5"></circle>
                                    <path d="M13 13l4 4" stroke="#6B46C1" stroke-width="2"></path>
                                </g>
                            </template>
                            <template if:true={el.showAssignmentIcon}>
                                <g transform={el.iconTransform}>
                                    <path d="M4 10h8M8 6l4 4-4 4" fill="none" stroke="#C05621" stroke-width="2"></path>
                                </g>
                            </template>
                            <template if:true={el.showLoopIcon}>
                                <g transform={el.iconTransform}>
                                    <!-- Circular arrow loop icon -->
                                    <circle cx="10" cy="10" r="6" fill="none" stroke="#6B46C1" stroke-width="2" stroke-dasharray="30 8"></circle>
                                    <path d="M16 8l-2 3 3 1" fill="#6B46C1"></path>
                                </g>
                            </template>
                            <template if:true={el.showActionIcon}>
                                <g transform={el.iconTransform}>
                                    <path d="M13 2L3 14h7l-1 6 10-12h-7l1-6z" fill="none" stroke="#B83280" stroke-width="1.5"></path>
                                </g>
                            </template>
                        </template>
                        
                        <!-- ============================================ -->
                        <!-- DIAMOND SHAPES (Gateways) -->
                        <!-- ============================================ -->
                        <template if:true={el.isDiamond}>
                            <!-- Selection: Blue stroke overlay -->
                            <template if:true={el.isSelected}>
                                <polygon
                                    points={el.selectionPoints}
                                    fill="none"
                                    stroke="#3182CE"
                                    stroke-width="3"
                                    class="selection-stroke"
                                ></polygon>
                            </template>
                            
                            <!-- Main diamond -->
                            <polygon
                                points={el.diamondPoints}
                                fill={el.fill}
                                stroke={el.stroke}
                                stroke-width={el.strokeWidth}
                            ></polygon>
                            
                            <!-- Loop indicator: Striped border overlay for elements in a loop -->
                            <template if:true={el.isInLoop}>
                                <polygon
                                    points={el.diamondPoints}
                                    fill="none"
                                    stroke={el.loopStroke}
                                    stroke-width="3"
                                    stroke-dasharray="6,3"
                                    class="loop-indicator"
                                ></polygon>
                                <!-- Loop badge at top-right of diamond -->
                                <circle
                                    cx={el.loopBadgeX}
                                    cy={el.loopBadgeY}
                                    r="10"
                                    fill={el.loopStroke}
                                    stroke="white"
                                    stroke-width="2"
                                ></circle>
                                <text
                                    x={el.loopBadgeX}
                                    y={el.loopBadgeY}
                                    text-anchor="middle"
                                    dominant-baseline="middle"
                                    fill="white"
                                    font-size="10"
                                >â†»</text>
                            </template>
                            
                            <!-- X icon for Exclusive Gateway (centered) -->
                            <template if:true={el.isXIcon}>
                                <path
                                    d={el.xIconPath}
                                    fill="none"
                                    stroke="#2D3748"
                                    stroke-width="3"
                                    stroke-linecap="round"
                                ></path>
                            </template>
                            
                            <!-- Plus icon for Parallel Gateway (centered) -->
                            <template if:true={el.isPlusIcon}>
                                <path
                                    d={el.plusIconPath}
                                    fill="none"
                                    stroke="#2D3748"
                                    stroke-width="3"
                                    stroke-linecap="round"
                                ></path>
                            </template>
                            
                            <!-- Circle icon for Inclusive Gateway (centered) -->
                            <template if:true={el.isCircleIcon}>
                                <circle
                                    cx={el.centerX}
                                    cy={el.centerY}
                                    r={el.circleIconRadius}
                                    fill="none"
                                    stroke="#2D3748"
                                    stroke-width="3"
                                ></circle>
                            </template>
                            
                            <!-- Gateway label (below) - Line 1 always shown -->
                            <text
                                x={el.labelX}
                                y={el.labelY}
                                text-anchor="middle"
                                dominant-baseline="hanging"
                                class="element-label"
                            >{el.labelLine1}</text>
                            <!-- Gateway label Line 2 (only if hasLine2) -->
                            <template if:true={el.hasLine2}>
                                <text
                                    x={el.labelX}
                                    y={el.labelLine2Y}
                                    text-anchor="middle"
                                    dominant-baseline="hanging"
                                    class="element-label"
                                >{el.labelLine2}</text>
                            </template>
                            
                            <!-- ============================================ -->
                            <!-- CFC COMPLEXITY BADGE (for split gateways) -->
                            <!-- Shows CFC contribution with traffic light colors -->
                            <!-- ============================================ -->
                            <template if:true={el.showComplexityBadge}>
                                <!-- Badge background (pill shape) -->
                                <rect
                                    class="cfc-badge-bg"
                                    x={el.badgeX}
                                    y={el.badgeY}
                                    width="22"
                                    height="16"
                                    rx="8"
                                    fill={el.complexityBadgeColor}
                                ></rect>
                                
                                <!-- Badge text (CFC number) -->
                                <text
                                    class="cfc-badge-text"
                                    x={el.badgeCenterX}
                                    y={el.badgeCenterY}
                                    text-anchor="middle"
                                    dominant-baseline="central"
                                    fill="#FFFFFF"
                                    font-size="10"
                                    font-weight="bold"
                                >
                                    {el.complexityBadgeText}
                                </text>
                            </template>
                        </template>
                        
                        <!-- ============================================ -->
                        <!-- LOOP CONTAINER (SubProcess - tight fit around body) -->
                        <!-- ============================================ -->
                        <template if:true={el.isLoopContainer}>
                            <!-- Selection: Blue stroke overlay -->
                            <template if:true={el.isSelected}>
                                <rect
                                    x={el.x}
                                    y={el.y}
                                    width={el.width}
                                    height={el.height}
                                    fill="none"
                                    stroke="#3182CE"
                                    stroke-width="3"
                                    rx="10"
                                    class="selection-stroke"
                                ></rect>
                            </template>
                            
                            <!-- Main loop container box (dashed border, tight fit) -->
                            <rect
                                x={el.x}
                                y={el.y}
                                width={el.width}
                                height={el.height}
                                fill={el.fill}
                                stroke={el.stroke}
                                stroke-width="2"
                                stroke-dasharray="8,5"
                                rx="12"
                            ></rect>
                            
                            <!-- Header bar at top -->
                            <rect
                                x={el.x}
                                y={el.y}
                                width={el.width}
                                height="28"
                                fill="rgba(139, 92, 246, 0.18)"
                                stroke="none"
                                rx="12"
                            ></rect>
                            <!-- Square bottom corners for header -->
                            <rect
                                x={el.x}
                                y={el.y}
                                width={el.width}
                                height="14"
                                fill="rgba(139, 92, 246, 0.18)"
                                stroke="none"
                                transform="translate(0, 18)"
                            ></rect>
                            
                            <!-- Loop icon and name in header -->
                            <text
                                x={el.x}
                                y={el.y}
                                dx="14"
                                dy="19"
                                text-anchor="start"
                                class="loop-container-label"
                            >ðŸ”„ {el.name}</text>
                            
                            <!-- Loop marker at bottom center -->
                            <circle
                                cx={el.loopMarkerX}
                                cy={el.loopMarkerY}
                                r="10"
                                fill="white"
                                stroke="#8B5CF6"
                                stroke-width="2"
                            ></circle>
                            <path
                                d={el.loopMarkerPath}
                                fill="none"
                                stroke="#8B5CF6"
                                stroke-width="2"
                                stroke-linecap="round"
                            ></path>
                        </template>
                        
                        <!-- ============================================ -->
                        <!-- POOL SHAPES (Swimlane Container) -->
                        <!-- ============================================ -->
                        <template if:true={el.isPool}>
                            <!-- Selection: Blue stroke overlay -->
                            <template if:true={el.isSelected}>
                                <rect
                                    x={el.x}
                                    y={el.y}
                                    width={el.width}
                                    height={el.height}
                                    fill="none"
                                    stroke="#3182CE"
                                    stroke-width="3"
                                    class="selection-stroke"
                                ></rect>
                            </template>
                            
                            <!-- Main pool container -->
                            <rect
                                x={el.x}
                                y={el.y}
                                width={el.width}
                                height={el.height}
                                fill={el.fill}
                                stroke={el.stroke}
                                stroke-width={el.strokeWidth}
                            ></rect>
                            
                            <!-- Pool header (orientation-aware) -->
                            <rect
                                x={el.headerRectX}
                                y={el.headerRectY}
                                width={el.headerRectWidth}
                                height={el.headerRectHeight}
                                fill="#E2E8F0"
                                stroke={el.stroke}
                                stroke-width="1"
                            ></rect>
                            
                            <!-- Pool label (rotated for horizontal, normal for vertical) -->
                            <text
                                x={el.poolLabelX}
                                y={el.poolLabelY}
                                text-anchor="middle"
                                dominant-baseline="middle"
                                class="element-label pool-label"
                                transform={el.poolLabelTransform}
                            >
                                {el.name}
                            </text>
                            
                            <!-- Resize handles (shown when selected) -->
                            <template if:true={el.showResizeHandles}>
                                <!-- North (top center) -->
                                <rect x={el.resizeHandleNX} y={el.resizeHandleNY} width="8" height="8" 
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-n"
                                      data-elementid={el.id} data-handle="n" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- South (bottom center) -->
                                <rect x={el.resizeHandleSX} y={el.resizeHandleSY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-s"
                                      data-elementid={el.id} data-handle="s" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- East (right center) -->
                                <rect x={el.resizeHandleEX} y={el.resizeHandleEY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-e"
                                      data-elementid={el.id} data-handle="e" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- West (left center) -->
                                <rect x={el.resizeHandleWX} y={el.resizeHandleWY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-w"
                                      data-elementid={el.id} data-handle="w" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- Northeast (top right corner) -->
                                <rect x={el.resizeHandleNEX} y={el.resizeHandleNEY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-ne"
                                      data-elementid={el.id} data-handle="ne" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- Northwest (top left corner) -->
                                <rect x={el.resizeHandleNWX} y={el.resizeHandleNWY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-nw"
                                      data-elementid={el.id} data-handle="nw" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- Southeast (bottom right corner) -->
                                <rect x={el.resizeHandleSEX} y={el.resizeHandleSEY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-se"
                                      data-elementid={el.id} data-handle="se" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- Southwest (bottom left corner) -->
                                <rect x={el.resizeHandleSWX} y={el.resizeHandleSWY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-sw"
                                      data-elementid={el.id} data-handle="sw" onmousedown={handleResizeHandleMouseDown}></rect>
                            </template>
                        </template>
                        
                        <!-- ============================================ -->
                        <!-- LANE SHAPES (Role/Department within Pool) -->
                        <!-- ============================================ -->
                        <template if:true={el.isLane}>
                            <!-- Selection: Blue stroke overlay -->
                            <template if:true={el.isSelected}>
                                <rect
                                    x={el.x}
                                    y={el.y}
                                    width={el.width}
                                    height={el.height}
                                    fill="none"
                                    stroke="#3182CE"
                                    stroke-width="3"
                                    class="selection-stroke"
                                ></rect>
                            </template>
                            
                            <!-- Main lane container -->
                            <rect
                                x={el.x}
                                y={el.y}
                                width={el.width}
                                height={el.height}
                                fill={el.fill}
                                stroke={el.stroke}
                                stroke-width={el.strokeWidth}
                            ></rect>
                            
                            <!-- Lane header (orientation-aware) -->
                            <rect
                                x={el.headerRectX}
                                y={el.headerRectY}
                                width={el.headerRectWidth}
                                height={el.headerRectHeight}
                                fill="#EDF2F7"
                                stroke={el.stroke}
                                stroke-width="1"
                            ></rect>
                            
                            <!-- Lane label (rotated for horizontal, normal for vertical) -->
                            <text
                                x={el.poolLabelX}
                                y={el.poolLabelY}
                                text-anchor="middle"
                                dominant-baseline="middle"
                                class="element-label lane-label"
                                transform={el.poolLabelTransform}
                            >
                                {el.name}
                            </text>
                            
                            <!-- Resize handles (shown when selected) -->
                            <template if:true={el.showResizeHandles}>
                                <!-- North (top center) -->
                                <rect x={el.resizeHandleNX} y={el.resizeHandleNY} width="8" height="8" 
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-n"
                                      data-elementid={el.id} data-handle="n" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- South (bottom center) -->
                                <rect x={el.resizeHandleSX} y={el.resizeHandleSY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-s"
                                      data-elementid={el.id} data-handle="s" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- East (right center) -->
                                <rect x={el.resizeHandleEX} y={el.resizeHandleEY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-e"
                                      data-elementid={el.id} data-handle="e" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- West (left center) -->
                                <rect x={el.resizeHandleWX} y={el.resizeHandleWY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-w"
                                      data-elementid={el.id} data-handle="w" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- Northeast (top right corner) -->
                                <rect x={el.resizeHandleNEX} y={el.resizeHandleNEY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-ne"
                                      data-elementid={el.id} data-handle="ne" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- Northwest (top left corner) -->
                                <rect x={el.resizeHandleNWX} y={el.resizeHandleNWY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-nw"
                                      data-elementid={el.id} data-handle="nw" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- Southeast (bottom right corner) -->
                                <rect x={el.resizeHandleSEX} y={el.resizeHandleSEY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-se"
                                      data-elementid={el.id} data-handle="se" onmousedown={handleResizeHandleMouseDown}></rect>
                                <!-- Southwest (bottom left corner) -->
                                <rect x={el.resizeHandleSWX} y={el.resizeHandleSWY} width="8" height="8"
                                      fill="#3182CE" stroke="#FFFFFF" stroke-width="1" class="resize-handle resize-sw"
                                      data-elementid={el.id} data-handle="sw" onmousedown={handleResizeHandleMouseDown}></rect>
                            </template>
                        </template>
                        
                        <!-- ============================================ -->
                        <!-- LABEL BELOW ELEMENT (for events & gateways) -->
                        <!-- ============================================ -->
                        <template if:false={el.labelInside}>
                            <text
                                x={el.labelX}
                                y={el.labelY}
                                text-anchor="middle"
                                dominant-baseline="hanging"
                                class="element-label"
                            >
                                {el.name}
                            </text>
                        </template>
                        
                        <!-- ============================================ -->
                        <!-- CONNECTION POINTS (shown when selected) -->
                        <!-- ============================================ -->
                        <template if:true={el.isSelected}>
                            <!-- Top -->
                            <circle
                                cx={el.connPointTopX}
                                cy={el.connPointTopY}
                                r="6"
                                class="connection-point"
                                data-elementid={el.id}
                                data-position="top"
                                onmousedown={handleConnectionPointMouseDown}
                            ></circle>
                            <!-- Right -->
                            <circle
                                cx={el.connPointRightX}
                                cy={el.connPointRightY}
                                r="6"
                                class="connection-point"
                                data-elementid={el.id}
                                data-position="right"
                                onmousedown={handleConnectionPointMouseDown}
                            ></circle>
                            <!-- Bottom -->
                            <circle
                                cx={el.connPointBottomX}
                                cy={el.connPointBottomY}
                                r="6"
                                class="connection-point"
                                data-elementid={el.id}
                                data-position="bottom"
                                onmousedown={handleConnectionPointMouseDown}
                            ></circle>
                            <!-- Left -->
                            <circle
                                cx={el.connPointLeftX}
                                cy={el.connPointLeftY}
                                r="6"
                                class="connection-point"
                                data-elementid={el.id}
                                data-position="left"
                                onmousedown={handleConnectionPointMouseDown}
                            ></circle>
                        </template>
                    </g>
                </template>
            </g>
        </svg>
        
        <!-- Zoom indicator (bottom-right) -->
        <div class="zoom-indicator">
            {zoomPercentage}%
        </div>
        
        <!-- Element Type Legend (top-left) -->
        <div class="element-legend">
            <div class="legend-row">
                <!-- Events -->
                <div class="legend-item-inline">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="7" fill="#E8F5E9" stroke="#4CAF50" stroke-width="2"></circle>
                    </svg>
                    <span>Start Event</span>
                </div>
                <div class="legend-item-inline">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <circle cx="9" cy="9" r="7" fill="#FFEBEE" stroke="#E57373" stroke-width="3"></circle>
                    </svg>
                    <span>End Event</span>
                </div>
                <!-- Tasks -->
                <div class="legend-item-inline">
                    <svg width="22" height="16" viewBox="0 0 22 16">
                        <rect x="1" y="1" width="20" height="14" rx="3" fill="#E3F2FD" stroke="#64B5F6" stroke-width="1.5"></rect>
                    </svg>
                    <span>Screen</span>
                </div>
                <div class="legend-item-inline">
                    <svg width="22" height="16" viewBox="0 0 22 16">
                        <rect x="1" y="1" width="20" height="14" rx="3" fill="#F3E5F5" stroke="#BA68C8" stroke-width="1.5"></rect>
                    </svg>
                    <span>Lookup</span>
                </div>
                <div class="legend-item-inline">
                    <svg width="22" height="16" viewBox="0 0 22 16">
                        <rect x="1" y="1" width="20" height="14" rx="3" fill="#E8F5E9" stroke="#81C784" stroke-width="1.5"></rect>
                    </svg>
                    <span>Create</span>
                </div>
                <div class="legend-item-inline">
                    <svg width="22" height="16" viewBox="0 0 22 16">
                        <rect x="1" y="1" width="20" height="14" rx="3" fill="#E3F2FD" stroke="#64B5F6" stroke-width="1.5"></rect>
                    </svg>
                    <span>Update</span>
                </div>
                <div class="legend-item-inline">
                    <svg width="22" height="16" viewBox="0 0 22 16">
                        <rect x="1" y="1" width="20" height="14" rx="3" fill="#FFF3E0" stroke="#FFB74D" stroke-width="1.5"></rect>
                    </svg>
                    <span>Assignment</span>
                </div>
                <div class="legend-item-inline">
                    <svg width="22" height="16" viewBox="0 0 22 16">
                        <rect x="1" y="1" width="20" height="14" rx="3" fill="#FCE4EC" stroke="#F06292" stroke-width="1.5"></rect>
                    </svg>
                    <span>Action</span>
                </div>
                <!-- Gateway -->
                <div class="legend-item-inline">
                    <svg width="20" height="20" viewBox="0 0 20 20">
                        <polygon points="10,2 18,10 10,18 2,10" fill="#FFFDE7" stroke="#FFD54F" stroke-width="1.5"></polygon>
                        <path d="M7,7 L13,13 M13,7 L7,13" stroke="#5D4037" stroke-width="2" stroke-linecap="round"></path>
                    </svg>
                    <span>Decision (XOR)</span>
                </div>
                <!-- Loop indicator -->
                <div class="legend-item-inline">
                    <svg width="22" height="16" viewBox="0 0 22 16">
                        <rect x="1" y="1" width="20" height="14" rx="3" fill="#FFF3E0" stroke="#8B5CF6" stroke-width="2" stroke-dasharray="4,2"></rect>
                    </svg>
                    <span>Loop Element</span>
                </div>
            </div>
        </div>
        
        <!-- Complexity Indicators Legend (bottom-left) -->
        <div class="complexity-legend">
            <h4 class="legend-title">Complexity Indicators</h4>
            <div class="legend-item">
                <span class="legend-color legend-high"></span>
                <span class="legend-label">High (CFC 7+)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color legend-medium"></span>
                <span class="legend-label">Medium (CFC 4-6)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color legend-low"></span>
                <span class="legend-label">Low (CFC 1-3)</span>
            </div>
        </div>
    </div>
</template>