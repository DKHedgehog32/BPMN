<!--
  @description: Main template for the Process Modeling Studio
  @author: Dennis van Musschenbroek (DvM) - Cobra CRM B.V.
  @date: 2024-12-14
  @version: 1.1.0
  
  EXPLANATION:
  Layout structure for the process modeler with:
  - Toolbar at top
  - Palette on left
  - Canvas in center
  - Properties panel on right (now includes Process Quality Score)
  - New Process modal for creating processes
  
  CHANGELOG:
  Version | Date       | Author | Description
  ---------|------------|--------|------------------------------------------
  1.0.0   | 2024-12-12 | DvM    | Initial creation
  1.0.1   | 2024-12-12 | DvM    | Added new process modal support
  1.1.0   | 2024-12-14 | DvM    | Added score-data binding to properties panel
-->
<template>
    <div class={containerClass}>
        <!-- Loading Spinner -->
        <template if:true={isLoading}>
            <div class="loading-overlay">
                <lightning-spinner alternative-text="Loading process..." size="large"></lightning-spinner>
                <p class="loading-text">Loading process...</p>
            </div>
        </template>
        
        <!-- Error State (only show if not a new process) -->
        <template if:true={showError}>
            <div class="error-container">
                <lightning-icon icon-name="utility:error" size="large" variant="error"></lightning-icon>
                <h2>Error Loading Process</h2>
                <p>{error}</p>
                <lightning-button 
                    label="Retry" 
                    variant="brand" 
                    onclick={loadProcessData}
                ></lightning-button>
            </div>
        </template>
        
        <!-- Main Modeler UI -->
        <template if:true={showCanvas}>
            <!-- Toolbar -->
            <div class="toolbar-wrapper">
                <c-process-toolbar
                    process-name={processName}
                    process-status={processStatus}
                    current-version={currentVersion}
                    has-unsaved-changes={hasUnsavedChanges}
                    is-saving={isSaving}
                    read-only={isReadOnly}
                    zoom-level={zoomLevel}
                    onsave={handleSave}
                    onpublish={handlePublish}
                    onzoomin={handleZoomIn}
                    onzoomout={handleZoomOut}
                    onzoomfit={handleZoomFit}
                    onzoomreset={handleZoomReset}
                    ontogglegrid={handleToggleGrid}
                    ontogglesnap={handleToggleSnap}
                    onundo={handleUndo}
                    onredo={handleRedo}
                    ondeleteselected={handleDeleteSelected}
                    onclone={handleClone}
                    onexport={handleExport}
                    onversionhistory={handleVersionHistory}
                ></c-process-toolbar>
            </div>
            
            <!-- Main Content Area -->
            <div class="content-wrapper">
                <!-- Left Panel: Palette (hide in read-only mode) -->
                <template if:false={isReadOnly}>
                    <div class="palette-wrapper">
                        <c-process-palette
                            onimportclick={handleImportFromSalesforce}
                        ></c-process-palette>
                    </div>
                </template>
                
                <!-- Center: Canvas -->
                <div class="canvas-wrapper">
                    <c-process-canvas
                        process-id={effectiveProcessId}
                        read-only={isReadOnly}
                        oncanvaschange={handleCanvasChange}
                        onselectionchange={handleSelectionChange}
                        onflowimported={handleFlowImported}
                    ></c-process-canvas>
                </div>
                
                <!-- Right Panel: Properties (now includes score-data) -->
                <div class="properties-wrapper">
                    <c-process-properties
                        selected-element={selectedElement}
                        selected-connection={selectedConnection}
                        score-data={scoreData}
                        imported-flow-info={importedFlowInfo}
                        read-only={isReadOnly}
                        onpropertychange={handlePropertyChange}
                        ondeleteelement={handleDeleteElement}
                        ondeleteconnection={handleDeleteConnection}
                        onopensuggestions={handleOpenSuggestions}
                    ></c-process-properties>
                </div>
            </div>
        </template>
        
        <!-- New Process Modal -->
        <template if:true={showNewProcessModal}>
            <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container">
                    <header class="slds-modal__header">
                        <button class="slds-button slds-button_icon slds-modal__close" onclick={handleCancelNewProcess}>
                            <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
                            <span class="slds-assistive-text">Close</span>
                        </button>
                        <h2 class="slds-modal__title">Save New Process</h2>
                    </header>
                    <div class="slds-modal__content slds-p-around_medium">
                        <lightning-input
                            label="Process Name"
                            value={newProcessName}
                            onchange={handleNewProcessNameChange}
                            required
                            class="slds-m-bottom_medium"
                        ></lightning-input>
                        <lightning-textarea
                            label="Description"
                            value={newProcessDescription}
                            onchange={handleNewProcessDescChange}
                            max-length="1000"
                        ></lightning-textarea>
                    </div>
                    <footer class="slds-modal__footer">
                        <lightning-button
                            label="Cancel"
                            onclick={handleCancelNewProcess}
                            class="slds-m-right_x-small"
                        ></lightning-button>
                        <lightning-button
                            label="Create Process"
                            variant="brand"
                            onclick={handleCreateProcess}
                        ></lightning-button>
                    </footer>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>
        
        <!-- Import Source Selection Modal -->
        <template if:true={showImportModal}>
            <template if:false={showImportSourceSelected}>
                <!-- Step 1: Choose Import Source -->
                <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
                    <div class="slds-modal__container">
                        <!-- Dark blue header -->
                        <div class="import-modal-header">
                            <button class="import-modal-close" onclick={handleImportModalClose}>
                                <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
                            </button>
                            <div class="import-modal-title">
                                <lightning-icon icon-name="utility:download" size="small"></lightning-icon>
                                <h2>Import Process</h2>
                            </div>
                        </div>
                        <div class="slds-modal__content slds-p-around_large">
                            <p class="slds-text-body_regular slds-m-bottom_large">Choose how you want to import your process:</p>
                            
                            <div class="import-source-options">
                                <!-- Option 1: Import from XML File -->
                                <div class="import-source-card" onclick={handleSelectXmlImport}>
                                    <div class="import-source-icon">
                                        <lightning-icon icon-name="doctype:xml" size="large"></lightning-icon>
                                    </div>
                                    <div class="import-source-content">
                                        <h3 class="import-source-title">Import from XML File</h3>
                                        <p class="import-source-description">Upload a Salesforce Flow XML file (.flow-meta.xml) from your local computer</p>
                                    </div>
                                    <div class="import-source-arrow">
                                        <lightning-icon icon-name="utility:chevronright" size="small"></lightning-icon>
                                    </div>
                                </div>
                                
                                <!-- Option 2: Import from Salesforce Org -->
                                <div class="import-source-card" onclick={handleSelectOrgImport}>
                                    <div class="import-source-icon">
                                        <lightning-icon icon-name="utility:salesforce1" size="large"></lightning-icon>
                                    </div>
                                    <div class="import-source-content">
                                        <h3 class="import-source-title">Import from Salesforce Org</h3>
                                        <p class="import-source-description">Browse and select Flows, Apex classes, or LWC components from your connected org</p>
                                    </div>
                                    <div class="import-source-arrow">
                                        <lightning-icon icon-name="utility:chevronright" size="small"></lightning-icon>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Layout Options -->
                            <div class="import-layout-section">
                                <h4 class="import-layout-title">Layout Options</h4>
                                <div class="layout-options-card">
                                    <div class="layout-option">
                                        <lightning-input 
                                            type="checkbox" 
                                            label="Organize into Swimlanes"
                                            checked={organizeIntoLanesOnImport}
                                            onchange={handleOrganizeLanesToggle}
                                            class="layout-checkbox"
                                        ></lightning-input>
                                        <p class="layout-option-description">Group elements by type: User Interaction, Process Logic, Data Operations</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <footer class="import-modal-footer">
                            <button class="footer-button footer-button-neutral" onclick={handleImportModalClose}>Cancel</button>
                        </footer>
                    </div>
                </section>
                <div class="slds-backdrop slds-backdrop_open"></div>
            </template>
            
            <!-- Step 2a: XML File Upload -->
            <template if:true={showXmlImport}>
                <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
                    <div class="slds-modal__container">
                        <!-- Dark blue header matching other modals -->
                        <div class="import-modal-header">
                            <button class="import-modal-close" onclick={handleImportModalClose}>
                                <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
                            </button>
                            <div class="import-modal-title">
                                <lightning-icon icon-name="doctype:xml" size="small"></lightning-icon>
                                <h2>Import from XML File</h2>
                            </div>
                        </div>
                        <div class="slds-modal__content slds-p-around_large">
                            <!-- Back button - styled consistently -->
                            <button class="back-button" onclick={handleBackToSourceSelection}>
                                <lightning-icon icon-name="utility:chevronleft" size="xx-small"></lightning-icon>
                                <span>Back to import options</span>
                            </button>
                            
                            <!-- File Upload Area -->
                            <div class={xmlUploadAreaClass} 
                                 ondragover={handleXmlDragOver} 
                                 ondragleave={handleXmlDragLeave}
                                 ondrop={handleXmlDrop}>
                                <template if:false={xmlFileSelected}>
                                    <div class="xml-upload-content">
                                        <lightning-icon icon-name="utility:upload" size="large" class="xml-upload-icon"></lightning-icon>
                                        <p class="xml-upload-text">Drag and drop your Flow XML file here</p>
                                        <p class="xml-upload-subtext">or</p>
                                        <label class="slds-button slds-button_neutral xml-upload-button">
                                            Browse Files
                                            <input type="file" accept=".xml,.flow-meta.xml" onchange={handleXmlFileSelect} class="slds-assistive-text" />
                                        </label>
                                        <p class="xml-upload-hint">Supported: .xml, .flow-meta.xml</p>
                                    </div>
                                </template>
                                <template if:true={xmlFileSelected}>
                                    <div class="xml-file-selected">
                                        <lightning-icon icon-name="doctype:xml" size="large"></lightning-icon>
                                        <div class="xml-file-info">
                                            <p class="xml-file-name">{xmlFileName}</p>
                                            <p class="xml-file-size">{xmlFileSize}</p>
                                        </div>
                                        <button class="slds-button slds-button_icon slds-button_icon-border" onclick={handleXmlFileRemove} title="Remove file">
                                            <lightning-icon icon-name="utility:close" size="x-small"></lightning-icon>
                                        </button>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Parse Error Message -->
                            <template if:true={xmlParseError}>
                                <div class="slds-notify slds-notify_alert slds-alert_error slds-m-top_medium" role="alert">
                                    <lightning-icon icon-name="utility:error" size="x-small" variant="inverse"></lightning-icon>
                                    <span class="slds-m-left_x-small">{xmlParseError}</span>
                                </div>
                            </template>
                            
                            <!-- Preview (after file is parsed) -->
                            <template if:true={xmlFlowPreview}>
                                <div class="xml-preview slds-m-top_large">
                                    <h3 class="slds-text-heading_small slds-m-bottom_small">Flow Preview</h3>
                                    <div class="xml-preview-card">
                                        <div class="xml-preview-row">
                                            <span class="xml-preview-label">Label:</span>
                                            <span class="xml-preview-value">{xmlFlowPreview.label}</span>
                                        </div>
                                        <div class="xml-preview-row">
                                            <span class="xml-preview-label">API Name:</span>
                                            <span class="xml-preview-value">{xmlFlowPreview.apiName}</span>
                                        </div>
                                        <div class="xml-preview-row">
                                            <span class="xml-preview-label">Process Type:</span>
                                            <span class="xml-preview-value">{xmlFlowPreview.processType}</span>
                                        </div>
                                        <div class="xml-preview-row">
                                            <span class="xml-preview-label">Elements:</span>
                                            <span class="xml-preview-value">{xmlFlowPreview.elementCount} elements</span>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <footer class="import-modal-footer">
                            <button class="footer-button footer-button-neutral" onclick={handleImportModalClose}>Cancel</button>
                            <button class="footer-button footer-button-brand" onclick={handleXmlImport} disabled={xmlImportDisabled}>
                                <lightning-icon icon-name="utility:download" size="x-small"></lightning-icon>
                                <span>Import Flow</span>
                            </button>
                        </footer>
                    </div>
                </section>
                <div class="slds-backdrop slds-backdrop_open"></div>
            </template>
            
            <!-- Step 2b: Salesforce Org Browser - Uses the existing selector component -->
            <template if:true={showOrgImport}>
                <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-modal_large slds-fade-in-open">
                    <div class="slds-modal__container">
                        <div class="slds-modal__content slds-p-around_none" style="height: 80vh; overflow: hidden;">
                            <c-salesforce-metadata-selector
                                onconvert={handleImportConvert}
                                oncancel={handleOrgImportCancel}
                            ></c-salesforce-metadata-selector>
                        </div>
                    </div>
                </section>
                <div class="slds-backdrop slds-backdrop_open"></div>
            </template>
        </template>
        
    </div>
        
        <!-- ============================================ -->
        <!-- SUGGESTIONS MODAL -->
        <!-- ============================================ -->
        <template if:true={showSuggestionsModal}>
            <section role="dialog" tabindex="-1" aria-modal="true" class="slds-modal slds-fade-in-open">
                <div class="slds-modal__container suggestions-modal-container">
                    <!-- Dark blue header matching Import modal -->
                    <div class="import-modal-header">
                        <button class="import-modal-close" onclick={handleCloseSuggestionsModal}>
                            <lightning-icon icon-name="utility:close" size="small"></lightning-icon>
                        </button>
                        <div class="import-modal-title">
                            <lightning-icon icon-name="utility:magicwand" size="small"></lightning-icon>
                            <h2>Improvement Suggestions</h2>
                        </div>
                    </div>
                    <div class="slds-modal__content slds-p-around_none">
                        <c-process-suggestions
                            score-data={scoreData}
                            onsuggestionselect={handleSuggestionSelect}
                        ></c-process-suggestions>
                    </div>
                </div>
            </section>
            <div class="slds-backdrop slds-backdrop_open"></div>
        </template>
</template>